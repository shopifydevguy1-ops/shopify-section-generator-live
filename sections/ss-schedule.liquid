{% comment %}
---------------------------------------------------------
Copyright © 2023 Section Store. All rights reserved.
Unauthorized copying, modification, distribution, or use
of this code or any portion of it, is strictly prohibited.
Violators will be prosecuted to the fullest extent of the law.
For inquiries or permissions, contact daniel@section.store
---------------------------------------------------------
{% endcomment %}

<div class="section-{{ section.id }} schedule-{{ section.id }}">
  <div class="section-{{ section.id }}-settings">
  </div>
</div>


<script>
  function initSchedule() {
    const inEditor = typeof Shopify !== 'undefined' && Shopify.designMode;

    // Find THIS scheduler section
    const currentContainer = document.querySelector('.schedule-{{ section.id }}');
    const currentSectionElement = currentContainer ? currentContainer.closest('.shopify-section') : null;

    // Find the NEXT real .shopify-section (controls the section BELOW)
    let sectionToControl = currentSectionElement ? currentSectionElement.nextElementSibling : null;
    while (sectionToControl && !sectionToControl.classList.contains('shopify-section')) {
      sectionToControl = sectionToControl.nextElementSibling;
    }
    if (!sectionToControl) return;

    const enableSchedule = {{ section.settings.enable_schedule | json }};

    // If scheduling is disabled → always show the controlled section (and keep scheduler visible)
    if (!enableSchedule) {
      sectionToControl.style.display = 'block';
      if (currentSectionElement) currentSectionElement.style.display = 'block';
      return;
    }

    // ---- Timezone-safe comparison (Fix #1) ----
    const pad = (n) => n.toString().padStart(2, '0');
    const tzToHours = (tz) => {
      // accepts formats like "UTC-6", "UTC+2", "UTC+0"
      const n = parseInt(String(tz).replace('UTC', ''), 10);
      return isNaN(n) ? 0 : n;
    };
    const toInstantUTC = (y, m, d, h, min, tzHours) => {
      // Build a UTC instant that corresponds to the "wall time" at the chosen timezone.
      // Example: 2025-10-18 09:00 at UTC+7 -> UTC hour = 09 - (+7) = 02
      return new Date(Date.UTC(y, parseInt(m, 10) - 1, d, h - tzHours, min, 0));
    };

    // Read begin/end values as numbers where relevant
    const beginMonth = '{{ section.settings.begin_month }}';
    const beginDay = {{ section.settings.begin_day }};
    const beginYear = '{{ section.settings.begin_year }}' === 'this_year'
      ? new Date().getFullYear()
      : new Date().getFullYear() + 1;
    const beginHour = parseInt('{{ section.settings.begin_hour }}', 10);
    const beginMinute = parseInt('{{ section.settings.begin_minute }}', 10);
    const beginTimezone = '{{ section.settings.begin_timezone }}';

    const endMonth = '{{ section.settings.end_month }}';
    const endDay = {{ section.settings.end_day }};
    const endYear = '{{ section.settings.end_year }}' === 'this_year'
      ? new Date().getFullYear()
      : new Date().getFullYear() + 1;
    const endHour = parseInt('{{ section.settings.end_hour }}', 10);
    const endMinute = parseInt('{{ section.settings.end_minute }}', 10);
    const endTimezone = '{{ section.settings.end_timezone }}';

    const beginInstant = toInstantUTC(
      beginYear, beginMonth, beginDay, beginHour, beginMinute, tzToHours(beginTimezone)
    );
    const endInstant = toInstantUTC(
      endYear, endMonth, endDay, endHour, endMinute, tzToHours(endTimezone)
    );

    const nowInstant = new Date(); // already UTC-based for comparisons

    const withinWindow = nowInstant >= beginInstant && nowInstant <= endInstant;

    if (withinWindow) {
      sectionToControl.style.display = 'block';
      if (currentSectionElement) currentSectionElement.style.display = 'block';
    } else {
      // Hide controlled section; keep scheduler visible in Theme Editor (Fix #2)
      sectionToControl.style.display = 'none';
      if (!inEditor && currentSectionElement) currentSectionElement.style.display = 'none';
      return;
    }
  }

  document.addEventListener('DOMContentLoaded', initSchedule);

  if (typeof Shopify !== 'undefined' && Shopify.designMode) {
    // Re-run when the section is reloaded/selected in the editor
    ['shopify:section:load', 'shopify:section:unload', 'shopify:section:select', 'shopify:section:deselect']
      .forEach(ev => document.addEventListener(ev, initSchedule));
  }
</script>


{% schema %}
  {
    "name": "SS - Schedule",
    "settings": [
      {
        "type": "paragraph",
        "content": "⚠️ Tip: Save to apply scheduling."
      },
      {
        "type": "header",
        "content": "Schedule"
      },
      {
        "type": "paragraph",
        "content": "Choose when the section directly below should appear on your storefront. If no schedule is set, it remains visible at all times."
      },
      {
        "type": "checkbox",
        "id": "enable_schedule",
        "label": "Enable schedule",
        "default": false
      },
      {
        "type": "header",
        "content": "Visible from",
        "info": "Choose the date and time when the section becomes visible."
      },
      {
        "type": "select",
        "id": "begin_month",
        "label": "Month",
        "default": "01",
        "options": [
          { "label": "January", "value": "01" },
          { "label": "February", "value": "02" },
          { "label": "March", "value": "03" },
          { "label": "April", "value": "04" },
          { "label": "May", "value": "05" },
          { "label": "June", "value": "06" },
          { "label": "July", "value": "07" },
          { "label": "August", "value": "08" },
          { "label": "September", "value": "09" },
          { "label": "October", "value": "10" },
          { "label": "November", "value": "11" },
          { "label": "December", "value": "12" }
        ]
      },
      {
        "type": "range",
        "id": "begin_day",
        "min": 1,
        "max": 31,
        "step": 1,
        "label": "Day of month",
        "default": 1
      },
      {
        "type": "radio",
        "id": "begin_year",
        "label": "Year",
        "options": [
          { "value": "this_year", "label": "This year" },
          { "value": "next_year", "label": "Next year" }
        ],
        "default": "this_year"
      },
      {
        "type": "select",
        "id": "begin_hour",
        "label": "Hour",
        "default": "00",
        "options": [
          { "label": "12:00 am", "value": "00" },
          { "label": "1:00 am", "value": "01" },
          { "label": "2:00 am", "value": "02" },
          { "label": "3:00 am", "value": "03" },
          { "label": "4:00 am", "value": "04" },
          { "label": "5:00 am", "value": "05" },
          { "label": "6:00 am", "value": "06" },
          { "label": "7:00 am", "value": "07" },
          { "label": "8:00 am", "value": "08" },
          { "label": "9:00 am", "value": "09" },
          { "label": "10:00 am", "value": "10" },
          { "label": "11:00 am", "value": "11" },
          { "label": "12:00 pm", "value": "12" },
          { "label": "1:00 pm", "value": "13" },
          { "label": "2:00 pm", "value": "14" },
          { "label": "3:00 pm", "value": "15" },
          { "label": "4:00 pm", "value": "16" },
          { "label": "5:00 pm", "value": "17" },
          { "label": "6:00 pm", "value": "18" },
          { "label": "7:00 pm", "value": "19" },
          { "label": "8:00 pm", "value": "20" },
          { "label": "9:00 pm", "value": "21" },
          { "label": "10:00 pm", "value": "22" },
          { "label": "11:00 pm", "value": "23" }
        ]
      },
      {
        "type": "select",
        "id": "begin_minute",
        "label": "Minute",
        "default": "00",
        "options": [
          { "label": "00", "value": "00" },
          { "label": "15", "value": "15" },
          { "label": "30", "value": "30" },
          { "label": "45", "value": "45" }
        ]
      },
      {
        "type": "select",
        "id": "begin_timezone",
        "label": "Timezone",
        "default": "UTC+1",
        "options": [
             { "label": "UTC-8 (PST – US & Canada West)", "value": "UTC-8" },
            { "label": "UTC-7 (MST – US & Canada Mtn)", "value": "UTC-7" },
            { "label": "UTC-6 (CST – US Central, Mexico)", "value": "UTC-6" },
            { "label": "UTC-5 (EST – US & Canada East)", "value": "UTC-5" },
            { "label": "UTC-4 (AST – Caribbean, Atl. Canada)", "value": "UTC-4" },
            { "label": "UTC-3 (BRT/ART – Brazil, Argentina)", "value": "UTC-3" },
            { "label": "UTC+0 (GMT – UK, Portugal)", "value": "UTC+0" },
            { "label": "UTC+1 (CET – Central Europe)", "value": "UTC+1" },
            { "label": "UTC+2 (EET/SAST – E. Europe, S. Africa)", "value": "UTC+2" },
            { "label": "UTC+3 (MSK/AST – E. Africa, Arabia)", "value": "UTC+3" },
            { "label": "UTC+8 (CST – China, Singapore)", "value": "UTC+8" },
            { "label": "UTC+9 (JST/KST – Japan, Korea)", "value": "UTC+9" },
            { "label": "UTC+10 (AEST – Australia East)", "value": "UTC+10" }
        ]
      },
      {
        "type": "header",
        "content": "Visible until",
        "info": "Choose the date and time when the section stops being visible."
      },
      {
        "type": "select",
        "id": "end_month",
        "label": "Month",
        "default": "12",
        "options": [
          { "label": "January", "value": "01" },
          { "label": "February", "value": "02" },
          { "label": "March", "value": "03" },
          { "label": "April", "value": "04" },
          { "label": "May", "value": "05" },
          { "label": "June", "value": "06" },
          { "label": "July", "value": "07" },
          { "label": "August", "value": "08" },
          { "label": "September", "value": "09" },
          { "label": "October", "value": "10" },
          { "label": "November", "value": "11" },
          { "label": "December", "value": "12" }
        ]
      },
      {
        "type": "range",
        "id": "end_day",
        "min": 1,
        "max": 31,
        "step": 1,
        "label": "Day of month",
        "default": 31
      },
      {
        "type": "radio",
        "id": "end_year",
        "label": "Year",
        "options": [
          { "value": "this_year", "label": "This year" },
          { "value": "next_year", "label": "Next year" }
        ],
        "default": "this_year"
      },
      {
        "type": "select",
        "id": "end_hour",
        "label": "Hour",
        "default": "23",
        "options": [
          { "label": "12:00 am", "value": "00" },
          { "label": "1:00 am", "value": "01" },
          { "label": "2:00 am", "value": "02" },
          { "label": "3:00 am", "value": "03" },
          { "label": "4:00 am", "value": "04" },
          { "label": "5:00 am", "value": "05" },
          { "label": "6:00 am", "value": "06" },
          { "label": "7:00 am", "value": "07" },
          { "label": "8:00 am", "value": "08" },
          { "label": "9:00 am", "value": "09" },
          { "label": "10:00 am", "value": "10" },
          { "label": "11:00 am", "value": "11" },
          { "label": "12:00 pm", "value": "12" },
          { "label": "1:00 pm", "value": "13" },
          { "label": "2:00 pm", "value": "14" },
          { "label": "3:00 pm", "value": "15" },
          { "label": "4:00 pm", "value": "16" },
          { "label": "5:00 pm", "value": "17" },
          { "label": "6:00 pm", "value": "18" },
          { "label": "7:00 pm", "value": "19" },
          { "label": "8:00 pm", "value": "20" },
          { "label": "9:00 pm", "value": "21" },
          { "label": "10:00 pm", "value": "22" },
          { "label": "11:00 pm", "value": "23" }
        ]
      },
      {
        "type": "select",
        "id": "end_minute",
        "label": "Minute",
        "default": "59",
        "options": [
          { "label": "00", "value": "00" },
          { "label": "15", "value": "15" },
          { "label": "30", "value": "30" },
          { "label": "45", "value": "45" },
          { "label": "59", "value": "59" }
        ]
      },
      {
        "type": "select",
        "id": "end_timezone",
        "label": "Timezone",
        "default": "UTC+1",
        "options": [
            { "label": "UTC-8 (PST – US & Canada West)", "value": "UTC-8" },
            { "label": "UTC-7 (MST – US & Canada Mtn)", "value": "UTC-7" },
            { "label": "UTC-6 (CST – US Central, Mexico)", "value": "UTC-6" },
            { "label": "UTC-5 (EST – US & Canada East)", "value": "UTC-5" },
            { "label": "UTC-4 (AST – Caribbean, Atl. Canada)", "value": "UTC-4" },
            { "label": "UTC-3 (BRT/ART – Brazil, Argentina)", "value": "UTC-3" },
            { "label": "UTC+0 (GMT – UK, Portugal)", "value": "UTC+0" },
            { "label": "UTC+1 (CET – Central Europe)", "value": "UTC+1" },
            { "label": "UTC+2 (EET/SAST – E. Europe, S. Africa)", "value": "UTC+2" },
            { "label": "UTC+3 (MSK/AST – E. Africa, Arabia)", "value": "UTC+3" },
            { "label": "UTC+8 (CST – China, Singapore)", "value": "UTC+8" },
            { "label": "UTC+9 (JST/KST – Japan, Korea)", "value": "UTC+9" },
            { "label": "UTC+10 (AEST – Australia East)", "value": "UTC+10" }
        ]
      }
    ],
    "presets": [
      {
        "name": "SS - Schedule"
      }
    ]
  }
{% endschema %}