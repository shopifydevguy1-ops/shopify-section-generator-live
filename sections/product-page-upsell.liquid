{% if section.blocks.size > 0 %}
  <style>
    .complete-look {
      display: grid;
      grid-template-columns: 100%;
      gap: 5px;
    }
    .complete-look__form {
      background-color: #f7f7f7;
    }
    .complete-look__wrap {
      display: flex;
      align-items: flex-start;
      padding-right: 15px;
    }
    .complete-look__img {
      max-width: 115px;
      height: auto;
      align-self: center;
    }
    @media only screen and (min-width: 768px) {
      .complete-look__img {
        max-width: 120px;
      }
    }
    .complete-look__product-details {
      padding: 10px 0 0 10px;
      flex: 1;
    }
    .complete-look__title-wrap {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .complete-look__link {
      display: block;
      text-decoration: none !important;
      padding-right: 10px;
      line-height: 1.2;
    }
    .complete-look__cta {
      box-shadow: none;
      cursor: pointer;

      display: inline-block;
      transition: background-color 0.3s, color 0.3s, border-color 0.3s;
      font-family: Brandon Black, Helvetica, Arial, sans-serif;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      text-align: center;
      line-height: 1;

      background-color: #000;
      border: 2px solid #000;
      color: #fff;

      font-size: 11px;
      flex-shrink: 0;
    }
    @media only screen and (min-width: 768px) {
      .complete-look__cta {
        min-width: 70px;
        padding: 10px;
      }
    }
  </style>
  <template id="custom-mini-atc">
    <div class="complete-look">
      {% for block in section.blocks %}
        {% assign product = block.settings.product %}
        <div data-mini-atc class="complete-look__form">
          <div class="complete-look__wrap">
            <img
              class="complete-look__img"
              src="{{ product.featured_image | img_url: '120x' }}"
              alt="{{ product.title }}"
              width="120"
              height="120"
              loading="lazy"
            >
            <div class="complete-look__product-details">
              <div class="complete-look__title-wrap">
                <a
                  class="complete-look__link"
                  href="{{ product.url }}"
                >
                  <div class="complete-look__product-title">
                    {{ product.title }}
                  </div>
                  <div
                    class="complete-look__product-price"
                  >
                    <span class="money notranslate">{{ product.price | money_with_currency }}</span>
                  </div>
                </a>
                <button
                  type="submit"
                  name="add"
                  class="complete-look__cta"
                  data-mini-add-to-cart
                  data-variant-id="{{ product.variants.first.id }}"
                >
                  Add
                </button>
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  </template>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Copy template content to #mini-atc-target
      const template = document.querySelector('#custom-mini-atc');
      const target = document.querySelector('#mini-atc-target');
      if (template && target) {
        target.innerHTML = template.innerHTML;
      }
      const addToCartButtons = document.querySelectorAll('[data-mini-add-to-cart]');
      addToCartButtons.forEach(function (button) {
        button.addEventListener('click', function () {
          // Use fetch to add product to cart to Shopify
          const variantId = button.getAttribute('data-variant-id');
          if (!variantId) return;

          button.innerHTML = 'Adding...';

          fetch('/cart/add.js', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              items: [
                {
                  id: variantId,
                  quantity: 1,
                },
              ],
            }),
          })
            .then(function (response) {
              return response.json();
            })
            .then(function (data) {
              button.innerHTML = 'Added';
              setTimeout(function () {
                button.innerHTML = 'Add';
              }, 2000);
            })
            .catch(function (error) {
              console.error(error);
              button.innerHTML = 'Error';
              setTimeout(function () {
                button.innerHTML = 'Add';
              }, 2000);
            });
        });
      });
    });
  </script>
{% endif %}

{% schema %}
{
  "name": "Upsell: Mini Add to Cart",
  "settings": [
    {
      "type": "html",
      "id": "html",
      "label": "HTML",
      "info": "Copy and paste the HTML from the template above",
      "default": "<div id='mini-atc-target'></div>"
    }
  ],
  "blocks": [
    {
      "type": "product",
      "name": "Product",
      "settings": [
        {
          "type": "product",
          "id": "product",
          "label": "Product",
          "info": "Select a product to display"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Upsell: Mini Add to Cart",
      "category": "Custom"
    }
  ]
}
{% endschema %}